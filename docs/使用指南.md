# PageIndex 知识库使用指南

## 快速开始（推荐）

### 使用 Docker 一键启动（最简单）

这是推荐的启动方式，无需手动安装 Python 和 PostgreSQL。

**前置条件**：
- 已安装 Docker Desktop

**Windows 用户**：
```cmd
REM 1. 复制环境变量模板
copy .env.example .env

REM 2. 编辑 .env 文件，设置：
REM    - DEEPSEEK_API_KEY=你的API密钥
REM    - POSTGRES_PASSWORD=你的数据库密码

REM 3. 一键启动
start.bat
```

**Linux/macOS 用户**：
```bash
# 1. 复制环境变量模板
cp .env.example .env

# 2. 编辑 .env 文件，设置：
#    - DEEPSEEK_API_KEY=你的API密钥
#    - POSTGRES_PASSWORD=你的数据库密码

# 3. 一键启动
chmod +x start.sh
./start.sh
```

启动成功后，访问：
- **API 文档**: http://localhost:8000/docs
- **健康检查**: http://localhost:8000/health

**日常管理命令**：
```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f app

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

---

## 手动安装方式

如果你不使用 Docker，可以手动安装。

### 1. 安装依赖

**安装 uv**（Python 包管理器）：
```bash
# Windows PowerShell
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"

# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh
```

**安装 PostgreSQL 16**：
- Windows: 从 [PostgreSQL 官网](https://www.postgresql.org/download/windows/) 下载
- macOS: `brew install postgresql@16`
- Linux: `sudo apt install postgresql`

### 2. 创建虚拟环境

```bash
# 创建虚拟环境
uv venv

# 激活虚拟环境
# Windows PowerShell
.venv\Scripts\activate

# Windows Git Bash / macOS / Linux
source .venv/bin/activate

# 安装依赖
uv pip install -r requirements.txt
```

### 3. 配置环境变量

编辑 `.env` 文件：
```env
# DeepSeek API 配置（必需）
DEEPSEEK_API_KEY=你的API密钥
DEEPSEEK_MODEL=deepseek-chat
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1

# 数据库配置（必需）
DATABASE_URL=postgresql://postgres:你的密码@localhost:5433/pageindex_kb

# PageIndex 配置（可选）
MAX_PAGE_NUM_EACH_NODE=10
MAX_TOKEN_NUM_EACH_NODE=20000

# 检索配置（可选）
DEFAULT_TOP_K=5
MAX_CONTEXT_TOKENS=16000
```

### 4. 启动服务

```bash
uv run python -m src.main
```

访问 http://localhost:8000/docs 查看 API 文档。

---

## 使用示例

### 上传文档

**通过 API 文档上传**：
1. 访问 http://localhost:8000/docs
2. 找到 `POST /api/documents/upload`
3. 点击 "Try it out"
4. 选择文件并执行

**通过 curl 上传**：
```bash
curl -X POST "http://localhost:8000/api/documents/upload" \
  -F "file=@data\20210309 平果市国土空间规划-初步汇报成果——2.7部分中心城区演变.pdf" 
```

**通过 Python 上传**：
```python
import requests

# 上传文档
with open("example.pdf", "rb") as f:
    response = requests.post(
        "http://localhost:8000/api/documents/upload",
        files={"file": f},
    )
doc = response.json()
print(f"文档 ID: {doc['id']}")
```

### 索引文档

上传文档后，需要先索引才能搜索：

```bash
# 索引文档（将 1 替换为你的文档 ID）
curl -X POST "http://localhost:8000/api/documents/1/index"
```

**索引说明**：
- 索引过程使用 DeepSeek API 进行智能解析
- 支持的文档格式：PDF、Markdown
- 索引时间取决于文档大小和复杂度
- 索引完成后会生成树状结构的知识库
- 可以通过 `/api/documents/{id}/status` 查询索引状态

**索引配置**（可选）：
在 `.env` 文件中可以调整索引参数：
- `MAX_PAGE_NUM_EACH_NODE=10`: 每个节点包含的最大页数
- `MAX_TOKEN_NUM_EACH_NODE=20000`: 每个节点的最大 token 数量

这些参数会影响索引的粒度和性能。

### 搜索文档

**Agent 智能搜索**（推荐）：
```bash
curl -X POST "http://localhost:8000/api/search/agent" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "文档的主要结论是什么？",
    "top_k": 5
  }'
```

**简单关键词搜索**：
```bash
curl -X POST "http://localhost:8000/api/search/simple" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "机器学习",
    "top_k": 3
  }'
```

---

## 常见问题

### 1. Docker 启动失败

**问题**：`Error: .env file not found`

**解决**：
```cmd
copy .env.example .env
REM 然后编辑 .env 文件
```

**问题**：`DEEPSEEK_API_KEY not set`

**解决**：在 `.env` 文件中设置有效的 DeepSeek API Key

### 2. API 调用失败

**问题**：`Authentication failed`

**解决**：
1. 检查 API Key 是否正确
2. 访问 [DeepSeek 控制台](https://platform.deepseek.com/) 查看余额
3. 检查网络连接

### 3. 搜索无结果

**解决**：
1. 确认文档已成功索引（检查索引状态）
2. 尝试使用更通用的关键词
3. 增加 `top_k` 参数值

### 4. 数据库连接失败

**Docker 用户**：
```bash
# 检查 PostgreSQL 容器状态
docker-compose ps

# 查看 PostgreSQL 日志
docker-compose logs postgres
```

**手动安装用户**：
```bash
# 检查 PostgreSQL 服务状态
# Windows
sc query postgresql-x64-16

# macOS/Linux
sudo systemctl status postgresql

# 检查数据库是否创建
psql -U postgres -l
```

### 5. 索引失败或卡住

**问题**：索引请求返回错误或长时间无响应

**解决**：
1. 检查 DeepSeek API Key 是否有效且有余额
2. 查看应用日志：`docker-compose logs -f app`
3. 确认文档格式是否支持（PDF 或 Markdown）
4. 尝试调整索引参数（增加 `MAX_PAGE_NUM_EACH_NODE` 或 `MAX_TOKEN_NUM_EACH_NODE`）

**问题**：索引后搜索无结果

**解决**：
1. 确认索引状态为 "indexed"（非 "indexing" 或 "failed"）
2. 检查文档内容是否为空或加密
3. 尝试使用更通用的搜索关键词

---

## 项目结构

```
PageIndex/
├── src/
│   ├── api/              # FastAPI 接口
│   │   ├── app.py        # 应用入口
│   │   └── routes/       # API 路由
│   ├── config/           # 配置管理
│   ├── core/             # 核心逻辑（索引、检索）
│   ├── storage/          # 数据库操作
│   └── agents/           # AI Agent
├── data/                 # 文档存储（Docker 持久化）
├── logs/                 # 日志文件（Docker 持久化）
├── docker-compose.yml    # Docker 编排配置
├── Dockerfile            # Docker 镜像构建
├── .env.example          # 环境变量模板
├── start.sh              # Linux/macOS 启动脚本
├── start.bat             # Windows 启动脚本
└── requirements.txt      # Python 依赖
```

---

## API 接口说明

### 文档管理

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/documents/upload` | POST | 上传文档 |
| `/api/documents` | GET | 获取文档列表 |
| `/api/documents/{id}` | GET | 获取文档详情 |
| `/api/documents/{id}` | DELETE | 删除文档 |
| `/api/documents/{id}/index` | POST | 索引文档 |
| `/api/documents/{id}/status` | GET | 获取索引状态 |

### 搜索

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/search/agent` | POST | Agent 智能搜索 |
| `/api/search/simple` | POST | 简单关键词搜索 |
| `/api/search/node/{node_id}` | GET | 获取节点内容 |
| `/api/search/document/{doc_id}/structure` | GET | 获取文档树状结构 |

---

## 重新开始指南

如果你想清空所有数据重新开始：

### Docker 用户

```bash
# 1. 停止并删除所有容器和卷
docker-compose down -v

# 2. 重新启动（会创建全新的数据库）
docker-compose up -d

# 3. 查看日志确认启动成功
docker-compose logs -f app
```

### 手动安装用户

```bash
# 1. 停止应用
# Ctrl+C 停止运行的服务

# 2. 删除数据库
psql -U postgres -c "DROP DATABASE IF EXISTS pageindex_kb;"
psql -U postgres -c "CREATE DATABASE pageindex_kb;"

# 3. 清空文档数据
rm -rf data/documents/*
rm -f logs/*.log

# 4. 重新启动应用
uv run python -m src.main
```

---

## 下一步

- 上传你的第一个文档
- 尝试不同的搜索查询
- 调整 `.env` 中的配置参数
- 集成到你的项目中

祝使用愉快！
